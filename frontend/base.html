<!DOCTYPE html>
<html lang="fr">

<head id="head-placeholder">
    <!-- Font Awesome local -->
    <link rel="stylesheet" href="css/all.min.css">
    <!-- JQUERY -->
    <meta charset="UTF-8">
    <script src="js/jquery3.2.0.min.js"></script>
    <script src="js/jquery3.2.0.treetable.min.js"></script>
    <script src="js/jquery.tablesorter.min.js"></script>
    <script src="js/jquery.tablesorter.pager.js"></script>
    <script src="js/jquery.tablesorter.widgets.js"></script>
    <script src="js/jquery.metadata.js"></script>
    <script src="js/jquery.contextMenu.min.js"></script>
    <!-- Fomantic UI -->
    <link rel="stylesheet" href="css/semantic.min.css">


    <!-- Alpine.js 3.8.1 (copié de l'ERP) -->
    <script defer src="js/alpinejs3.8.1.js"></script>
    <script defer src="js/app.js"></script>

    <!-- Semantic UI JS -->
    <script defer src="js/semantic.min.js"></script>
    <script src="js/moment-with-locales.min.js"></script>
    <link href="css/app_semantic.css" rel="stylesheet" media="screen">

    <!-- Styles persos -->
    <link rel="stylesheet" href="css/style.css">

</head>

<body x-data="$store.App" x-init="initApp()">
    <!-- Toast Notification -->
    <div x-data="$store.NotifToast" id="toast" style="z-index:9999; border-radius: 5px; border: 2px solid #636363;">
        <div style="position:absolute; top:0px; right: 8px; font-weight:bold;;" class="clickable" @click="close()">x
        </div>
        <div class="b" x-text="$store.NotifToast.title"></div>
        <div x-text="$store.NotifToast.message"></div>
    </div>
    </div>

    <!-- Application principale -->
    <div class="ui container" style="padding:0px" :class="{ 'blurred': $store.App.showLogin }">
        <!-- Navigation -->
        <div class="custom-navigation">
            <button class="nav-button primary" @click="$store.App.chargerPage('home')">
                <i class="fas fa-home"></i> Accueil
            </button>
            <button class="nav-button primary" @click="$store.App.chargerPage('edition')">Histoires</button>
        </div>

        <!-- Contenu dynamique -->
        <div id="main-content" style="margin-top: 2rem;"></div>
    </div>


    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('App', {


                async initApp() {
                    try {
                        // Charger la page d'accueil
                        await this.chargerPage('home');
                        Alpine.store('NotifToast').init();
                    } catch (error) {
                        console.error('Erreur initialisation:', error);
                        this.loginError = 'Erreur de connexion au serveur';
                    }
                },

                //navigation
                async chargerPage(page) {
                    try {
                        const html = await fetch(`pages/${page}.html`).then(res => res.text());
                        document.getElementById('main-content').innerHTML = html;

                        // Exécuter les scripts du contenu injecté
                        document.querySelectorAll('#main-content script').forEach(oldScript => {
                            const newScript = document.createElement('script');
                            if (oldScript.src) {
                                newScript.src = oldScript.src;
                            } else {
                                newScript.textContent = oldScript.textContent;
                            }
                            document.body.appendChild(newScript);
                            oldScript.remove();
                        });
                    } catch (error) {
                        console.error('Erreur chargement page:', error)
                    }
                },

                //bouton mise à jours
                async checkUpdates() {
                    try {
                        const current = await window.pywebview.api.get_version();
                        const json = await window.pywebview.api.fetch_latest();

                        if (json.error) throw new Error(json.error);
                        if (json.version !== current) {
                            if (confirm(`Nouvelle v${json.version} disponible.\nNotes:\n${json.notes}\n\nVoulez-vous télécharger ?`)) {
                                window.open(json.url, '_blank');
                            }
                        } else {
                            alert("Vous êtes à jour !");
                        }
                    } catch (e) {
                        console.error(e);
                        alert("Erreur vérification MAJ : " + e.message);
                    }
                },


            });
        });
    </script>
</body>


</html>