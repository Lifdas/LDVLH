<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Détails de l'histoire</title>
    <!-- Font Awesome local -->
    <link rel="stylesheet" href="../css/all.min.css">
    <!-- JQUERY -->
    <meta charset="UTF-8">
    <script src="../js/jquery3.2.0.min.js"></script>
    <script src="../js/jquery3.2.0.treetable.min.js"></script>
    <script src="../js/jquery.tablesorter.min.js"></script>
    <script src="../js/jquery.tablesorter.pager.js"></script>
    <script src="../js/jquery.tablesorter.widgets.js"></script>
    <script src="../js/jquery.metadata.js"></script>
    <script src="../js/jquery.contextMenu.min.js"></script>
    <!-- Fomantic UI -->
    <link rel="stylesheet" href="../css/semantic.min.css">

    <!-- Styles persos -->
    <link rel="stylesheet" href="../css/style.css">

    <!-- Alpine.js 3.8.1 (copié de l'ERP) -->
    <script defer src="../js/alpinejs3.8.1.js"></script>
    <script defer src="../js/app.js"></script>

    <!-- Semantic UI JS -->
    <script defer src="../js/semantic.min.js"></script>
    <script src="../js/moment-with-locales.min.js"></script>
    <link href="../css/app_semantic.css" rel="stylesheet" media="screen">


</head>

<body x-data="story_page" x-init="mounted"></body>
<div class="story-container">
    <div class="story-header">
        <h1 x-text="title"></h1>
    </div>
    <div>
        <button x-show="!storyStarted && !editing" @click="editingStory">Editer l'histoire</button>
        <button x-show="!storyStarted && !editing" @click="storyStart">Commencer l'histoire</button>
        <button x-show="storyStarted" @click="storyStart">Recommencer</button>
        <button x-show="storyStarted" @click="stopStory">Arrêter l'histoire</button>
        <button x-show="!storyStarted && editing" @click="stopEditing">Arrêter l'edition</button>
    </div>

    <!-- bloc évennement -->
    <div x-show="isShow">
        <div class="ui info message">
            <ul>
                <li>Votre histoire doit commencer à l'indice 1</li>
                <li>Ne pas donner de suite a l'indice 9999 il correspond aux héros et aux règles de l'aventure</li>
                <li>Pour un retour à la ligne écrivez &lt;br&gt; où ils ne seront pas enregistrés</li>
            </ul>
        </div>
        <div class="field">
            <label>Indice</label>
            <input type="number" x-model="form.indice" :disabled="disabled" min="0" style="width: 100px;">

        </div>
        <div class="field">
            <label>Évennement</label>
            <textarea x-model="form.event" style="resize: vertical;" placeholder="Entrez l'évennement ici"
                :disabled="disabled" id="content"></textarea>
        </div>

        <!-- bloc création de suites -->
        <div class="field" style="display: flex; align-items: center; gap: 10px;">
            <div>
                <label>Indice de suite</label>
                <input x-model="newIndice" style="width: 100px;">
            </div>
            <div>
                <label>Texte associé</label>
                <input x-model="newText" style="width: 369px;">
            </div>
        </div>
        <button @click="addIndice">Ajouter la suite à la liste</button>
        <div class="field">
            <label>Suites possible</label>
            <div id="indice-container" style="border: 1px solid #ccc; padding: 5px;
        width: 100%; min-height: 40px; display: flex;
        flex-wrap: wrap; align-items: center; cursor: text;">
                <template x-for="(objet, index) in form.indices" :key="index">
                    <div
                        style="display: flex; align-items: center; background: #007BFF; color: white; border-radius: 4px; padding: 5px 8px; margin: 3px;">
                        <span x-text="objet.choix? objet.choix : objet.name"></span>
                        <span style="margin-left: 8px; cursor: pointer;" @click="removeIndice(objet)">
                            ❌</span>
                    </div>
                </template>
                <!-- <input type="text" id="indiceInput" placeholder="Ajouter un indice..."
                    style="border: none; outline: none; flex: 1; padding: 5px;" x-model="newIndice"
                    @keydown.enter.prevent="addIndice" @keydown.tab.prevent="addIndice" @blur="addIndice"
                    :disabled="disabled"> -->
            </div>
            <!-- bloc création héro -->
            <div class="action-buttons">
                <button @click="resetForm()">
                    Nouvel évennement
                </button>
                <button x-show="!editEvent" @click="createEvent()">
                    Créer
                </button>
                <button x-show="editEvent" @click="updateEvent()">
                    Modifier
                </button>
                <button @click="deleteEvent()">
                    Supprimer l'évennement
                </button>
            </div>
            <div class="ui grid" style="margin-top: 20px;">
                <h2>Création de héros</h2>
                <button x-show="!newHero" @click="newHero = true">Créer un héros</button>
                <button x-show="newHero" @click="newHero = false">Fermer</button>
            </div>
                <div class="field" x-show="newHero" x-transition.opacity.duration.500ms>
                    <label>Nom</label>
                    <input x-model="hero.name" type="text" style="width: 300px;">
                    <label>Compétences</label>
                    <textarea x-model="hero.skills" type="text" style="width: 300px;"></textarea>
                    <button x-show="newHero" @click="createHero">Ajouter le héros</button>
                </div>
        </div>
    </div>

    <!-- bloc histoire -->
    <div x-show="storyStarted && storyShow" class="field">
        <h2 x-text="heroSelected.name"></h2>
        <label>Vos compétences</label>
        <textarea id="content" x-model="heroSelected.skills"
            x-init="$el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px'"
            @input="$el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px'"
            class="resize-none overflow-hidden w-full border rounded p-2"></textarea>
    </div>

    <div x-show="storyShow">
        <div>
            <!-- Numéro de l’étape -->
            <div x-text="event.indice"></div>

            <!-- Texte narratif -->
            <div x-html="event.event"></div>

            <!-- Boutons de choix -->
            <div x-show="!selectHero" class="space-y-2">
                <template x-for="(objet, index) in event.indices" :key="index">
                    <button @click="get_event(objet.indice)">
                        <span x-html="objet.choix"></span>
                    </button>
                </template>
            </div>
            <div x-show="selectHero" class="space-y-2">
                <template x-for="(hero, index) in event.indices" :key="index">
                    <button @click="get_event(1, hero)">
                        <span x-html="hero.name+' <br> '+hero.skills"></span>
                    </button>
                </template>
            </div>
        </div>
    </div>

    <table class="table-auto border-collapse border border-gray-400 w-full" x-show="isShow">
        <thead class="bg-gray-200">
            <tr>
                <th class="border border-gray-400 px-2 py-1">Indice</th>
                <th class="border border-gray-400 px-2 py-1">Événement</th>
                <th class="border border-gray-400 px-2 py-1">Indices suivants</th>
            </tr>
        </thead>
        <tbody style="overflow-y: auto;">
            <template x-for="(event, index) in eventList" :key="index">
                <tr>
                    <td class="border border-gray-400 px-2 py-1" x-text="event.indice"></td>
                    <td class="border border-gray-400 px-2 py-1 clickable" @click="selectEvent" x-text="event.event">
                    </td>
                    <td class="border border-gray-400 px-2 py-1">
                        <template x-for="(objet, idx) in event.indices" :key="idx">
                            <span style="display: flex; align-items: center; flex-wrap: wrap;">
                                <a class="cursor-pointer text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-1 py-0.5 rounded font-medium clickable"
                                    @click="goToIndice(objet)"
                                    x-text="objet.indice ? objet.indice : (objet.name ? objet.name : 'Aucun')">
                                </a>
                                <a x-show="idx < event.indices.length - 1" class="text-gray-400 mx-2">•</a>
                            </span>
                        </template>
                    </td>
                </tr>
            </template>
        </tbody>
    </table>



    <script>
        function getParam(name) {
            const hash = window.location.hash.substring(1);
            return new URLSearchParams(hash).get(name);
        }
        document.addEventListener('alpine:init', () => {
            Alpine.data('story_page', () => ({
                title: getParam('story'),
                isShow: false,
                storyShow: false,
                storyStarted: false,
                selectHero: false,
                newHero: false,
                hero: {
                    name: '',
                    skills: ''
                },
                heroSelected: {
                    name: '',
                    skills: ''
                },
                form: {
                    indice: '',
                    event: '',
                    indices: []
                },
                disabled: false,
                newIndice: '',
                newText: '',
                event: {},
                eventList: [],
                editing: false,
                editEvent: false,

                mounted() {
                    window.addEventListener('pywebviewready', async () => {
                        try {
                            this.event = await window.pywebview.api.get_story(this.title);

                        } catch (error) {
                            Alpine.store('NotifToast').error('Erreur lors de la récupération des données').show();
                        }
                    });

                },

                async get_event(indice = false, hero = false) {
                    if (this.selectHero) {
                        this.heroSelected.name = hero.name
                        this.heroSelected.skills = hero.skills
                        this.selectHero = false

                    }
                    await pywebview.api.get_event(this.title, indice)
                        .then(response => {
                            if (response) {
                                this.event = response;
                            }
                        })
                        .catch(err => {
                            Alpine.store('NotifToast').error("Erreur lors de la récupération de l'évènement").show();
                        });
                },

                storyStart() {
                    this.resetForm();
                    this.storyShow = true;
                    this.get_event(9999); // Démarrer à l'indice 9999 pour les persos
                    this.storyStarted = true;
                    this.selectHero = true;
                },

                stopStory() {
                    this.get_event(9999); // Démarrer à l'indice 0
                    this.storyShow = false;
                    this.storyStarted = false;
                    this.resetForm();

                },
                stopEditing() {
                    this.isShow = false;
                    this.editing = false;
                    this.resetForm();
                },

                editingStory() {
                    this.isShow = !this.isShow;
                    this.editing = true;
                    this.storyShow = false;
                    this.get_story();
                },

                get_story() {
                    pywebview.api.get_story(this.title)
                        .then(response => {
                            if (response) {
                                this.eventList = response;
                            }
                        })
                        .catch(err => {
                            Alpine.store('NotifToast').error("Erreur lors de la récupération de l'histoire").show();

                        });
                },

                selectEvent() {
                    this.editEvent = true;
                    if (this.editing && this.event.indice !== '') {
                        this.form.indice = this.event.indice;
                        this.form.event = this.event.event;
                        if (this.event.indices == null) {
                            this.form.indices = [];
                        }
                        else {
                            this.form.indices = [...this.event.indices];
                        }
                        this.isShow = true;
                        this.disabled = false;
                    }
                },

                deleteEvent() {
                    if (this.form.indice !== '') {
                        if (confirm(`Êtes-vous sûr de vouloir supprimer l'événement n°${this.form.indice} ?`)) {
                            pywebview.api.delete_event(this.title, this.form.indice)
                                .then((response) => {
                                    if (response == true) {
                                        this.resetForm();
                                        this.event = {};
                                        this.get_story();
                                    }
                                })
                                .catch(err => {
                                    Alpine.store('NotifToast').error("Erreur lors de la suppression de l'évènement").show();
                                });
                        }
                    }
                },

                async createEvent() {
                    await pywebview.api.create_event(this.title, this.form)
                        .then((response) => {
                            if (response) {
                                this.resetForm();
                                this.get_story();

                            }
                        })
                        .catch(err => {
                            Alpine.store('NotifToast').error("Erreur lors de la création de l'évènement").show();

                        });

                },

                async createHero() {
                    await pywebview.api.createHero(this.title, this.hero)
                        .then((response) => {
                            if (response) {
                                this.resetForm();
                                this.get_story();

                            }
                        })
                },

                async updateEvent() {
                    await pywebview.api.update_event(this.title, this.form)
                        .then((response) => {
                            if (response == true) {
                                this.resetForm();
                                this.get_story();
                            }
                        })
                        .catch(err => {
                            Alpine.store('NotifToast').error("Erreur lors de la mise à jour de l'évènement").show();

                        });
                },

                resetForm() {
                    this.form = {
                        indice: '',
                        event: '',
                        indices: []
                    };
                    this.hero = {
                        name: '',
                        skills: ''
                    };
                    this.newIndice = '';
                    this.newText = '';
                    this.editEvent = false;
                    this.heroSelected.name = '';
                    this.heroSelected.skills = '';
                },

                addIndice() {
                    let indiceNumber = this.newIndice.trim();
                    let indiceText = this.newText;

                    // Vérifier si l'indice existe déjà
                    let existe = this.form.indices.some(obj => obj.indice === indiceNumber);

                    if (existe) {
                        alert("L'indice existe déjà dans la liste.");
                        this.newIndice = "";
                        return;
                    }

                    // Ajouter l'indice car il n'existe pas
                    this.form.indices.push({ indice: indiceNumber, choix: indiceText });
                    this.newIndice = "";
                    this.newText = "";
                },

                removeIndice(indiceNumber) {
                    this.form.indices = this.form.indices.filter(indice => indice !== indiceNumber); //supprime l'indice sélectionné
                },

                goToIndice(objet) {
                    console.log(objet);
                    if (objet.indice) {
                        // Utiliser data-indice
                        let row = document.querySelector(`tr[data-indice='${objet.indice}']`);

                        // Chercher par contenu
                        if (!row) {
                            const allRows = document.querySelectorAll('tbody tr');
                            row = Array.from(allRows).find(r => {
                                const firstCell = r.querySelector('td:first-child');
                                return firstCell && firstCell.textContent.trim() === objet.indice.toString();
                            });
                        }

                        if (row) {
                            // Effet visuel temporaire
                            row.style.backgroundColor = '#fef3c7';
                            row.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center',
                                inline: 'nearest'
                            });
                            setTimeout(() => row.style.backgroundColor = '', 2000);
                        }
                    }
                    else if (objet.name) {
                        this.newHero = true;
                        this.hero.name = objet.name;
                        this.hero.skills = objet.skills;
                    }
                }
            }))
        })

    </script>
    </body>

</html>